@page "/entries"
@rendermode InteractiveServer
@using Planning.Models
@using Planning.Services
@inject ITimeEntryService TimeEntryService
@inject ICategoryService CategoryService

<PageTitle>Time Entries</PageTitle>

<div class="min-h-screen bg-black text-white">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">Time Entries</h1>
            <p class="text-gray-400">Manage your daily and monthly time logs with ease.</p>
        </div>

        <!-- Filters and Actions -->
        <div class="mb-6 flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
            <div class="flex gap-4">
                <!-- Month Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Month:</label>
                    <select @bind="selectedMonth" @bind:after="LoadEntries"
                            class="bg-gray-900 border border-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>

                <!-- Year Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Year:</label>
                    <select @bind="selectedYear" @bind:after="LoadEntries"
                            class="bg-gray-900 border border-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        @for (int year = DateTime.Now.Year - 5; year <= DateTime.Now.Year + 1; year++)
                        {
                            <option value="@year">@year</option>
                        }
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-2">
                <button @onclick="OpenAddModal" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex items-center gap-2">
                    <span>+</span> Add Entry
                </button>
                @if (selectedEntry != null)
                {
                    <button @onclick="OpenEditModal" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center gap-2">
                        <span>âœŽ</span> Edit Entry
                    </button>
                    <button @onclick="DeleteEntry" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded flex items-center gap-2">
                        <span>ðŸ—‘</span> Delete Entry
                    </button>
                }
            </div>
        </div>

        <!-- Entries Table -->
        @if (entries == null)
        {
            <div class="text-center py-8">
                <p class="text-gray-400">Loading...</p>
            </div>
        }
        else if (!entries.Any())
        {
            <div class="bg-gray-900 rounded-lg p-8 text-center">
                <p class="text-gray-400">No entries found for this month.</p>
            </div>
        }
        else
        {
            <div class="bg-gray-900 rounded-lg overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-800">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Hours</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Task Description</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800">
                        @foreach (var entry in entries)
                        {
                            <tr class="hover:bg-gray-800 cursor-pointer @(selectedEntry?.Id == entry.Id ? "bg-gray-800" : "")"
                                @onclick="() => SelectEntry(entry)">
                                <td class="px-6 py-4 whitespace-nowrap">@entry.Date.ToString("yyyy-MM-dd")</td>
                                <td class="px-6 py-4 whitespace-nowrap text-green-400">@entry.Hours.ToString("0.0")</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    @if (entry.Category != null)
                                    {
                                        <span class="inline-flex items-center gap-2 px-2 py-1 rounded text-sm">
                                            <span class="w-3 h-3 rounded-full" style="background-color: @entry.Category.Color"></span>
                                            @entry.Category.Name
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-gray-500">-</span>
                                    }
                                </td>
                                <td class="px-6 py-4">@entry.Description</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Summary -->
            <div class="mt-4 text-right text-gray-400">
                <span class="font-semibold">Total Hours: </span>
                <span class="text-green-400 text-lg">@entries.Sum(e => e.Hours).ToString("0.0")</span>
            </div>
        }
    </div>
</div>

<!-- Add/Edit Modal -->
@if (showModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" @onclick="CloseModal">
        <div class="bg-gray-900 rounded-lg p-6 w-full max-w-md" @onclick:stopPropagation="true">
            <h2 class="text-2xl text-white font-bold mb-4">@(isEditMode ? "Edit Entry" : "Add Entry")</h2>

            <EditForm Model="@currentEntry" OnValidSubmit="SaveEntry">
                <DataAnnotationsValidator />

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Date:</label>
                    <InputDate @bind-Value="currentEntry.Date"
                               class="w-full bg-gray-800 border border-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" />
                    <ValidationMessage For="@(() => currentEntry.Date)" class="text-red-500 text-sm mt-1" />
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Hours:</label>
                    <InputNumber @bind-Value="currentEntry.Hours"
                                 class="w-full bg-gray-800 border border-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" />
                    <ValidationMessage For="@(() => currentEntry.Hours)" class="text-red-500 text-sm mt-1" />
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Category:</label>
                    <div class="flex gap-2">
                        <select @bind="currentEntry.CategoryId"
                                class="flex-1 bg-gray-800 border border-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">-- No Category --</option>
                            @foreach (var category in activeCategories)
                            {
                                <option value="@category.Id">@category.Name</option>
                            }
                        </select>
                        <button type="button" @onclick="OpenQuickAddCategory" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white px-3 py-2 rounded flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Task Description:</label>
                    <InputTextArea @bind-Value="currentEntry.Description" rows="4"
                                   class="w-full bg-gray-800 border border-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" />
                    <ValidationMessage For="@(() => currentEntry.Description)" class="text-red-500 text-sm mt-1" />
                </div>

                <div class="flex gap-2 justify-end">
                    <button type="button" @onclick="CloseModal" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded">
                        Cancel
                    </button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                        Save
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

<!-- Quick Add Category Modal -->
@if (showQuickAddModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" @onclick="CloseQuickAddModal">
        <div class="bg-gray-900 rounded-lg p-6 w-full max-w-sm border border-gray-800" @onclick:stopPropagation="true">
            <h3 class="text-xl text-white font-semibold mb-4">Quick Add Category</h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-white">Name</label>
                    <input @bind="newCategory.Name" type="text" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white focus:outline-none focus:border-green-500" />
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-white">Color</label>
                    <div class="flex gap-2">
                        <input @bind="newCategory.Color" type="color" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 h-10 w-16" />
                        <input @bind="newCategory.Color" type="text" class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white focus:outline-none focus:border-green-500" placeholder="#10b981" />
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button @onclick="SaveQuickCategory" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-medium transition-colors">
                        Add
                    </button>
                    <button @onclick="CloseQuickAddModal" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded font-medium transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<TimeEntry>? entries;
    private TimeEntry? selectedEntry;
    private TimeEntry currentEntry = new();
    private bool showModal = false;
    private bool isEditMode = false;
    private int selectedMonth = DateTime.Now.Month;
    private int selectedYear = DateTime.Now.Year;

    private List<Category> activeCategories = new();
    private bool showQuickAddModal = false;
    private Category newCategory = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
        await LoadEntries();
    }

    private async Task LoadCategories()
    {
        activeCategories = await CategoryService.GetActiveCategoriesAsync();
    }

    private async Task LoadEntries()
    {
        entries = await TimeEntryService.GetEntriesByMonthYearAsync(selectedMonth, selectedYear);
        selectedEntry = null;
    }

    private void SelectEntry(TimeEntry entry)
    {
        selectedEntry = entry;
    }

    private void OpenAddModal()
    {
        currentEntry = new TimeEntry { Date = DateTime.Today };
        isEditMode = false;
        showModal = true;
    }

    private void OpenEditModal()
    {
        if (selectedEntry != null)
        {
            currentEntry = new TimeEntry
            {
                Id = selectedEntry.Id,
                Date = selectedEntry.Date,
                Hours = selectedEntry.Hours,
                Description = selectedEntry.Description,
                CategoryId = selectedEntry.CategoryId
            };
            isEditMode = true;
            showModal = true;
        }
    }

    private void CloseModal()
    {
        showModal = false;
        currentEntry = new();
    }

    private void OpenQuickAddCategory()
    {
        newCategory = new Category();
        showQuickAddModal = true;
    }

    private void CloseQuickAddModal()
    {
        showQuickAddModal = false;
        newCategory = new Category();
    }

    private async Task SaveQuickCategory()
    {
        if (string.IsNullOrWhiteSpace(newCategory.Name))
            return;

        var createdCategory = await CategoryService.CreateCategoryAsync(newCategory);
        await LoadCategories();
        currentEntry.CategoryId = createdCategory.Id;
        CloseQuickAddModal();
    }

    private async Task SaveEntry()
    {
        if (isEditMode)
        {
            await TimeEntryService.UpdateEntryAsync(currentEntry);
        }
        else
        {
            await TimeEntryService.CreateEntryAsync(currentEntry);
        }

        await LoadEntries();
        CloseModal();
    }

    private async Task DeleteEntry()
    {
        if (selectedEntry != null)
        {
            await TimeEntryService.DeleteEntryAsync(selectedEntry.Id);
            await LoadEntries();
        }
    }
}
