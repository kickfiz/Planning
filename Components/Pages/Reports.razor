@page "/reports"
@rendermode InteractiveServer
@using Planning.Models
@using Planning.Services
@inject ITimeEntryService TimeEntryService
@inject ICategoryService CategoryService

<PageTitle>Reports</PageTitle>

<div class="min-h-screen bg-black text-white">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">Reports Overview</h1>
        </div>

        @if (isLoading)
        {
            <div class="text-center py-8">
                <p class="text-gray-400">Loading...</p>
            </div>
        }
        else
        {
            <!-- Monthly Performance Overview -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Monthly Performance Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Total Hours Logged -->
                    <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-gray-400 text-sm">Total Hours Logged</span>
                            <span class="text-green-400">⏱</span>
                        </div>
                        <div class="text-3xl font-bold">@totalHours hours</div>
                        @if (totalHours > 0 && percentageChange != 0)
                        {
                            <div class="@(percentageChange > 0 ? "text-green-400" : "text-red-400") text-sm mt-1">
                                @(percentageChange > 0 ? "+" : "")@percentageChange% vs. last month
                            </div>
                        }
                    </div>

                    <!-- Tasks Completed -->
                    <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-gray-400 text-sm">Tasks Completed</span>
                            <span class="text-blue-400">☰</span>
                        </div>
                        <div class="text-3xl font-bold">@tasksCompleted tasks</div>
                        @if (newTasksCompleted > 0)
                        {
                            <div class="text-green-400 text-sm mt-1">@newTasksCompleted new tasks completed</div>
                        }
                    </div>

                    <!-- Average Daily Hours -->
                    <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-gray-400 text-sm">Average Daily Hours</span>
                            <span class="text-yellow-400">◉</span>
                        </div>
                        <div class="text-3xl font-bold">@averageDailyHours hours</div>
                        <div class="text-gray-400 text-sm mt-1">Consistent with target</div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Analytics</h2>
                    <div class="flex gap-2 bg-gray-900 p-1 rounded-lg border border-gray-800">
                        <button @onclick="() => ToggleView(false)" class="px-4 py-2 rounded @(!showAnnualView ? "bg-green-500 text-white" : "text-gray-400 hover:text-white") transition-colors">
                            Monthly
                        </button>
                        <button @onclick="() => ToggleView(true)" class="px-4 py-2 rounded @(showAnnualView ? "bg-green-500 text-white" : "text-gray-400 hover:text-white") transition-colors">
                            Annual
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Hours Chart -->
                    <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
                        <h3 class="text-lg font-semibold mb-2">@(showAnnualView ? "Monthly Hours Logged" : $"Daily Hours - {currentMonth:MMMM yyyy}")</h3>
                        <p class="text-gray-400 text-sm mb-6">@(showAnnualView ? "Total hours tracked over the year." : "Hours logged each day this month.")</p>

                        @if (chartData.Any())
                        {
                            <div class="relative h-64">
                                <!-- Y-axis labels -->
                                <div class="absolute left-0 top-0 h-full flex flex-col justify-between text-xs text-gray-500">
                                    <span>@maxChartValue</span>
                                    <span>@(maxChartValue * 0.75m)</span>
                                    <span>@(maxChartValue * 0.5m)</span>
                                    <span>@(maxChartValue * 0.25m)</span>
                                    <span>0</span>
                                </div>

                                <!-- Chart area -->
                                <div class="ml-8 h-full flex items-end justify-between gap-1">
                                    @foreach (var data in chartData)
                                    {
                                        var height = maxChartValue > 0 ? (data.Hours / maxChartValue * 100) : 0;
                                        height = Math.Max(height, 2); // Minimum height for visibility
                                        <div class="flex-1 flex flex-col items-center">
                                            <div class="w-full bg-blue-600 rounded-t hover:bg-blue-500 transition-colors"
                                                 style="height: @(height)%"
                                                 title="@data.Label: @data.Hours hours"></div>
                                        </div>
                                    }
                                </div>

                                <!-- X-axis labels -->
                                <div class="ml-8 mt-2 flex justify-between text-xs text-gray-500">
                                    @foreach (var data in chartData)
                                    {
                                        <span class="flex-1 text-center">@data.Label</span>
                                    }
                                </div>
                            </div>

                            <div class="mt-6 flex items-center gap-2 text-sm">
                                <span class="w-3 h-3 bg-blue-600 rounded"></span>
                                <span class="text-gray-400">Hours Logged</span>
                            </div>
                        }
                        else
                        {
                            <div class="h-64 flex items-center justify-center text-gray-500">
                                <p>No data available for this period</p>
                            </div>
                        }
                    </div>

                    <!-- Time Distribution by Category -->
                    <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
                        <h3 class="text-lg font-semibold mb-2">Time Distribution by Category</h3>
                        <p class="text-gray-400 text-sm mb-6">Breakdown of hours spent across different project categories.</p>

                        @if (categoryData.Any())
                        {
                            <!-- Pie Chart (Simulated with CSS) -->
                            <div class="flex items-center justify-center mb-6">
                                <div class="relative w-48 h-48">
                                    <div class="absolute inset-0 rounded-full" style="background: @BuildConicGradient()">
                                    </div>
                                    <div class="absolute inset-8 rounded-full bg-gray-900"></div>
                                </div>
                            </div>

                            <!-- Legend -->
                            <div class="space-y-2">
                                @foreach (var category in categoryData)
                                {
                                    <div class="flex items-center justify-between text-sm">
                                        <div class="flex items-center gap-2">
                                            <span class="w-3 h-3 rounded-full" style="background-color: @category.Color"></span>
                                            <span class="text-gray-300">@category.CategoryName</span>
                                        </div>
                                        <span class="text-gray-400">@category.Hours.ToString("0.0")h (@category.Percentage.ToString("0")%)</span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="h-64 flex items-center justify-center text-gray-500">
                                <p>No category data available for this period</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private bool isLoading = true;
    private bool showAnnualView = true;
    private DateTime currentMonth = DateTime.Now;
    private int currentYear = DateTime.Now.Year;

    // KPI data
    private int totalHours = 0;
    private int tasksCompleted = 0;
    private int newTasksCompleted = 0;
    private int percentageChange = 0;
    private string averageDailyHours = "0";

    // Chart data
    private List<ChartDataPoint> chartData = new();
    private decimal maxChartValue = 200;
    private List<CategoryDataPoint> categoryData = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadReportData();
        isLoading = false;
    }

    private async Task LoadReportData()
    {
        // Load KPI statistics for current month
        var stats = await TimeEntryService.GetMonthlyStatisticsAsync(currentMonth.Month, currentMonth.Year);

        totalHours = (int)(stats.ContainsKey("TotalHours") ? stats["TotalHours"] : 0);
        tasksCompleted = (int)(stats.ContainsKey("TasksCompleted") ? stats["TasksCompleted"] : 0);
        averageDailyHours = (stats.ContainsKey("AverageDailyHours") ? stats["AverageDailyHours"] : 0).ToString("0.0");

        // Load chart data based on view mode
        await LoadChartData();
        await LoadCategoryData();
    }

    private async Task LoadChartData()
    {
        chartData.Clear();

        if (showAnnualView)
        {
            // Load annual data (12 months)
            var annualData = await TimeEntryService.GetAnnualHoursAsync(currentYear);
            chartData = annualData.Select(d => new ChartDataPoint
            {
                Label = d.MonthName,
                Hours = d.Hours
            }).ToList();
        }
        else
        {
            // Load monthly data (days in current month)
            var monthlyData = await TimeEntryService.GetMonthlyHoursByDayAsync(currentMonth.Month, currentMonth.Year);
            var daysInMonth = DateTime.DaysInMonth(currentMonth.Year, currentMonth.Month);

            // Create data points for all days of the month
            chartData = Enumerable.Range(1, daysInMonth)
                .Select(day => new ChartDataPoint
                {
                    Label = day.ToString(),
                    Hours = monthlyData.FirstOrDefault(d => d.Day == day).Hours
                })
                .ToList();
        }

        // Calculate max value for Y-axis
        maxChartValue = chartData.Any() ? Math.Ceiling(chartData.Max(d => d.Hours) / 10) * 10 : 200;
        if (maxChartValue == 0) maxChartValue = 10;
    }

    private async Task LoadCategoryData()
    {
        categoryData.Clear();

        int? month = showAnnualView ? null : currentMonth.Month;
        int year = showAnnualView ? currentYear : currentMonth.Year;

        var distribution = await CategoryService.GetCategoryDistributionWithColorsAsync(month, year);
        var totalHours = distribution.Sum(d => d.Hours);

        if (totalHours > 0)
        {
            categoryData = distribution.Select(d => new CategoryDataPoint
            {
                CategoryName = d.CategoryName,
                Color = d.Color,
                Hours = d.Hours,
                Percentage = (d.Hours / totalHours) * 100
            }).ToList();
        }
    }

    private async Task ToggleView(bool annual)
    {
        showAnnualView = annual;
        await LoadChartData();
        await LoadCategoryData();
    }

    private string BuildConicGradient()
    {
        if (!categoryData.Any()) return "conic-gradient(from 0deg, #374151 0deg 360deg)";

        var totalHours = categoryData.Sum(c => c.Hours);
        var gradientParts = new List<string>();
        decimal currentAngle = 0;

        foreach (var category in categoryData)
        {
            var percentage = category.Hours / totalHours;
            var angle = percentage * 360;
            var startAngle = currentAngle;
            var endAngle = currentAngle + angle;

            gradientParts.Add($"{category.Color} {startAngle}deg {endAngle}deg");
            currentAngle = endAngle;
        }

        return $"conic-gradient(from 0deg, {string.Join(", ", gradientParts)})";
    }

    private class ChartDataPoint
    {
        public string Label { get; set; } = string.Empty;
        public decimal Hours { get; set; }
    }

    private class CategoryDataPoint
    {
        public string CategoryName { get; set; } = string.Empty;
        public string Color { get; set; } = string.Empty;
        public decimal Hours { get; set; }
        public decimal Percentage { get; set; }
    }
}
